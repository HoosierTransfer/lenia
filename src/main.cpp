#include <SDL2/SDL.h>
#include "grid.hpp"
#include "math.hpp"
#include <cstdio>
#include <string>
#include <iostream>
#include <ctime>
#include "imgui_impl_sdlrenderer2.h"
#include "imgui_impl_sdl2.h"
#include "implot.h"
#include <regex>
#include <algorithm>
#include "parser.hpp"

const std::string B_SIMP[] = {"0", "1/12", "1/6", "1/4", "1/3", "5/12", "1/2", "7/12", "2/3", "3/4", "5/6", "11/12", "1",
			"13/12", "7/6", "5/4", "4/3", "17/12", "3/2", "19/12", "5/3", "7/4", "11/6", "23/12", "2"};

const std::string coreName[] = {"bump4", "quad4", "trap1/5", "stpz1/4", "life"};



std::vector<std::string> split(const std::string &s, const std::regex &sep_regex) {
  std::sregex_token_iterator iter(s.begin(), s.end(), sep_regex, -1);
  std::sregex_token_iterator end;
  return {iter, end};
}

void parse(std::string str, Grid& grid) {
    int x = 54;
    int y = 54;
    std::string cell = "";
    for (int i = 0; i < str.length(); i++) {
        if (str[i] == ',') {
            grid.set(x, y, std::stod(cell));
            cell = "";
            x++;
        } else if (str[i] == '/') {
            grid.set(x, y, std::stod(cell));
            cell = "";
            x = 54;
            y++;
        } else {
            cell += str[i];
        }
    }
}

int main(int argc, char* argv[]) {
    int randomSpots = argc > 1 ? std::stoi(argv[1]) : 20;
    srand(time(NULL));
    ogrid(-10, 10, -10, 10);

    SDL_Init(SDL_INIT_VIDEO);
    SDL_Window* window = SDL_CreateWindow("SDL2 Window", SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED, 1000, 1000, 0);
    // this is because i made this on wsl
    #ifdef _WIN32
        SDL_Renderer* renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);
    #else
        SDL_Renderer* renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_SOFTWARE);
    #endif

    IMGUI_CHECKVERSION();
    ImGui::CreateContext();
    ImPlot::CreateContext();
    ImGuiIO& io = ImGui::GetIO(); (void)io;

    ImGui_ImplSDL2_InitForSDLRenderer(window, renderer);
    ImGui_ImplSDLRenderer2_Init(renderer);

    SDL_Texture* texture = SDL_CreateTexture(renderer, SDL_PIXELFORMAT_ARGB8888, SDL_TEXTUREACCESS_TARGET, 640, 640);
    
    
    bool running = true;
    SDL_Event event;

    int frameStart, frameTime;
    int fps = 0;
    int frameCount = 0;
    int lastTime = SDL_GetTicks();
    ParseRule("R=18;k=quad4(1,11/12);d=quad4(0.32,0.051)*0.1;cells=0");
// R=18;k=quad4(1,11/12);d=quad4(0.32,0.051)*0.1;cells=0,0,0,0,0,0,0,0,0,0,0,0.008933,0.016513,0.022453,0.021081,0.013978,0.007037,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0.000473,0.027474,0.070834,0.123042,0.17125,0.206514,0.224115,0.224575,0.211927,0.189726,0.163733,0.131003,0.0946,0.051993,0.012062,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0.032058,0.10985,0.210536,0.320233,0.422126,0.503859,0.557891,0.587935,0.596804,0.593092,0.581679,0.564791,0.535657,0.489032,0.414356,0.309528,0.179479,0.054415,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0.006964,0.076336,0.200766,0.357964,0.533892,0.705437,0.852505,0.961971,1,1,1,1,1,1,1,1,0.940293,0.817286,0.644946,0.429571,0.197069,0.021205,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0.009388,0.101902,0.263961,0.47333,0.714284,0.960767,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.950938,0.674167,0.364081,0.099242,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0.003558,0.093918,0.27696,0.523309,0.820695,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.884964,0.542199,0.246871,0.067396,0.008918,0.001854,0.002108,0.004159,0.005581,0.003942,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0.057735,0.239136,0.492812,0.816848,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.772926,0.534155,0.398803,0.350517,0.347318,0.350375,0.342138,0.308049,0.244491,0.159306,0.070154,0.01055,0,0,0,0,0,0,0,0,0,0,0,0/0,0.0151,0.16316,0.405546,0.714111,1,1,1,1,1,1,1,0.997287,0.997761,0.998325,0.99637,0.992869,0.991395,0.996571,1,1,1,1,1,1,1,1,1,1,1,0.961883,0.956616,0.951919,0.922566,0.859459,0.755656,0.610372,0.434356,0.256023,0.112586,0.026885,0,0,0,0,0,0,0,0,0,0/0,0.072261,0.292681,0.572626,0.907989,1,1,1,1,1,0.97503,0.93577,0.914372,0.903573,0.879076,0.836012,0.78255,0.744293,0.757048,0.843689,0.984086,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.931913,0.697265,0.455688,0.249745,0.11,0.030074,0,0,0,0,0,0,0,0/0.004254,0.158108,0.423339,0.713636,1,1,1,1,1,0.982562,0.912367,0.865672,0.843312,0.807002,0.724329,0.602006,0.478506,0.394516,0.380484,0.467697,0.673667,0.929619,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.908281,0.630241,0.391519,0.216093,0.09009,0.015144,0,0,0,0,0,0/0.029266,0.255668,0.539401,0.806475,1,1,1,1,1,0.956973,0.897859,0.892296,0.905035,0.855283,0.685631,0.420178,0.184852,0.053206,0.012558,0.065458,0.232783,0.491345,0.716552,0.808139,0.787981,0.726115,0.716469,0.821396,0.994602,1,1,1,1,1,1,1,1,1,1,1,1,0.785929,0.527365,0.320059,0.155993,0.039328,0,0,0,0,0/0.071811,0.346178,0.623153,0.842382,1,1,1,1,1,0.96452,0.961435,1,1,1,0.911019,0.409766,0,0,0,0,0,0,0.065435,0.061944,0.001047,0,0.002607,0.158775,0.479281,0.88898,1,1,1,1,1,1,1,1,1,1,1,1,0.932298,0.65132,0.40392,0.199777,0.052503,0,0,0,0/0.117142,0.416006,0.659641,0.92452,1,1,1,1,1,0.992728,1,1,1,1,1,0.749457,0,0,0,0,0,0,0,0,0,0,0,0,0,0.269947,0.749685,0.986114,1,0.997878,0.983593,0.986267,1,1,1,1,1,1,1,1,0.742207,0.448119,0.207267,0.046613,0,0,0/0.148883,0.445866,0.641208,1,1,1,1,1,1,1,1,1,1,1,1,0.541909,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.103956,0.462771,0.606857,0.621945,0.637116,0.710227,0.837627,0.962636,1,1,1,1,1,1,1,0.769098,0.436103,0.176669,0.026501,0,0/0.152653,0.426595,0.568893,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.059219,0.137752,0.223127,0.362385,0.554527,0.768721,0.934619,1,1,1,1,1,1,1,0.711896,0.361695,0.115761,0.004347,0/0.124854,0.363724,0.528188,1,1,1,1,1,1,0.968995,0.994495,1,1,1,1,1,0.285029,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.070185,0.301114,0.555963,0.780057,0.924348,0.99049,1,1,1,1,1,1,0.571431,0.242106,0.046378,0/0.072063,0.272915,0.599258,1,1,1,1,1,1,0.890161,0.85329,0.943958,0.991954,0.998521,0.980937,0.893272,0.402907,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.124297,0.427648,0.674476,0.829758,0.917218,0.972589,1,1,1,1,1,0.781585,0.381048,0.114035,0.00079/0.015154,0.172339,0.568309,1,1,1,1,1,1,0.842553,0.674215,0.715658,0.804116,0.836157,0.790603,0.659158,0.360594,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.143559,0.528245,0.743611,0.83066,0.868864,0.913274,0.97428,1,1,1,1,0.977066,0.509123,0.189044,0.01863/0,0.070969,0.437669,0.838949,1,1,1,1,1,0.938152,0.590843,0.515103,0.562378,0.59041,0.541955,0.401674,0.162349,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.735013,0.993976,0.998395,0.970703,0.901356,0.886539,0.944858,1,1,1,1,1,0.60913,0.254203,0.041686/0,0.000354,0.201822,0.597092,0.941662,1,1,1,1,1,0.78525,0.491082,0.425903,0.407778,0.332335,0.154819,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.439884,0.89736,1,1,1,0.987836,0.909711,0.943553,1,1,1,1,1,0.667329,0.299208,0.06078/0,0,0.000469,0.296648,0.643377,1,1,1,1,1,1,0.911409,0.617398,0.44831,0.274726,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.704453,1,1,1,1,1,1,0.957201,0.968323,1,1,1,1,1,0.676378,0.317967,0.070145/0,0,0,0,0.267478,0.743479,1,1,1,1,1,0.818553,1,0.991307,0.605901,0.020801,0.004184,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.418486,0.96435,1,1,1,1,1,1,0.99048,0.995326,1,1,1,1,1,0.649183,0.315848,0.066938/0,0,0,0,0,0.251888,0.806321,1,1,1,1,1,1,1,0.778082,0.596316,0.445905,0.307876,0.171042,0.046271,0,0,0,0,0,0,0,0,0,0,0,0,0,0.621615,0.89193,1,1,1,1,1,1,1,1,1,1,1,1,0.905947,0.605274,0.296523,0.052255/0,0,0,0,0,0,0.193377,0.723847,1,1,1,1,1,1,1,1,1,0.934327,0.730734,0.491033,0.24272,0.056266,0,0,0,0,0,0,0,0,0,0,0.169765,0.509279,0.759395,0.919222,0.990015,1,1,1,1,1,1,1,1,1,1,0.795292,0.55292,0.259373,0.031182/0,0,0,0,0,0,0,0,0.453013,0.804792,0.9903,0.99848,0.998089,0.999304,1,1,1,1,1,0.991646,0.810499,0.574989,0.345728,0.169184,0.062879,0.017469,0.000927,0,0,0,0,0,0.099969,0.397169,0.602378,0.737202,0.82191,0.865904,0.890068,0.936341,0.997169,1,1,1,1,1,1,0.696264,0.490082,0.202975,0.008582/0,0,0,0,0,0,0,0,0,0,0.272833,0.477707,0.596386,0.657812,0.674562,0.665915,0.671949,0.756372,0.909049,0.980259,1,1,0.975295,0.803252,0.631989,0.489253,0.386954,0.302509,0.201497,0.081268,0.001221,0,0.152312,0.355837,0.475389,0.548463,0.59597,0.647036,0.746467,0.922152,1,1,1,1,1,1,0.826437,0.603385,0.407755,0.128683,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.056573,0.051729,0.119051,0.367154,0.734823,0.902214,0.975024,0.999123,1,1,1,0.948005,0.884723,0.800435,0.642192,0.402658,0.162992,0.532076,0.585044,0.543713,0.516142,0.535892,0.636891,0.850053,1,1,1,1,1,1,1,0.561101,0.504843,0.297887,0.049704,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.188799,0.534714,0.743082,0.857026,0.916642,0.948911,0.966824,0.982576,1,1,1,1,0.910127,0.657142,0.845845,1,0.975268,0.969113,1,1,1,1,1,1,1,1,1,0.457127,0.38378,0.163231,0.001159,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.228492,0.420191,0.543553,0.612153,0.644207,0.611727,0.694144,0.920407,1,1,1,1,1,1,0.985741,1,1,1,1,1,1,1,1,1,0.633272,0.345154,0.228749,0.03783,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.029788,0.098226,0.303697,0.667928,0.978766,1,1,1,1,1,1,1,1,1,1,1,1,0.947802,0.792887,0.232162,0.199572,0.062797,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.157586,0.464185,0.81853,0.997562,1,1,1,1,1,1,1,1,0.991039,0.750235,0.615913,0.353513,0.115511,0.040702,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.129164,0.479212,0.773672,0.967396,1,1,1,1,0.909456,0.671266,0.471092,0.350832,0.220554,0.032082,0.002705,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.187723,0.347939,0.419893,0.409486,0.322144,0.178675,0.044695,0,0,0,0,0,0,0,0,0,0
    // limus
    GridTemplate gt;
    gt.coreId = 1;
    gt.layerId = 3;
    gt.kernel_B = {1.0/4.0, 1.0/2.0, 3.0/4.0, 1.0};
    gt.alpha = 4;
    gt.mu = 0.2;
    gt.sigma = 0.02;
    gt.kernelRadius = 18;
    gt.updateFrequency = 10;
    Grid grid(renderer, 128, 128, gt);
    parse(
        "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.004623,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.009306,0.377848,0.540738,0.40135,0.102397,0,0.106441,0.269446,0.218586,0.006525,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.144874,0.429219,0.535085,0.458401,0.327106,0.423087,0.689118,0.752357,0.707958,0.699299,0.514508,0.408516,0.474658,0.483924,0.39178,0.122488,0.004492,0.01288,0.028742,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0.135634,0.445322,0.62519,0.6787,0.721175,0.799217,0.83123,0.788514,0.662204,0.517404,0.476013,0.621237,0.638103,0.54638,0.466562,0.43915,0.439998,0.210131,0.105709,0.118862,0.086788,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0.172105,0.375614,0.453363,0.505804,0.573862,0.634307,0.650596,0.659855,0.617697,0.406338,0.360494,0.533721,0.584166,0.487686,0.206974,0.04945,0.307844,0.471245,0.435857,0.365079,0.370365,0.435513,0.25924,0.210528,0.213767,0.103428,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.029102,0.292943,0.392502,0.417781,0.354488,0.290547,0.361339,0.503201,0.622269,0.612025,0.106245,0.024685,0.048032,0.242856,0.356909,0.073526,0,0,0.195553,0.429026,0.374198,0.172132,0.278954,0.392212,0.299184,0.301405,0.272795,0.074746,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0.07325,0.185223,0.28875,0.344749,0.376035,0.45303,0.36962,0.180497,0.21434,0.211889,0.23843,0.174633,0.011676,0,0,0,0,0,0,0,0,0.234455,0.31495,0.024731,0,0.339715,0.393462,0.377439,0.3502,0.253939,0.022101,0,0,0,0,0,0,0/0,0,0,0,0.044042,0.149506,0.125106,0.025922,0,0.048157,0.15057,0.278123,0.2938,0.223427,0.21114,0.18715,0.13089,0.004958,0,0,0,0,0,0,0,0,0,0,0.133528,0,0,0.092338,0.465282,0.462444,0.364729,0.321598,0.145384,0,0,0,0,0,0,0/0,0,0,0,0.031978,0.129615,0.176491,0.01881,0,0,0,0.023495,0.193673,0.215329,0.22207,0.172119,0.036961,0,0,0.113238,0,0,0,0.144717,0.155347,0,0,0,0.167017,0,0,0,0.334537,0.475081,0.294094,0.256184,0.304995,0.052918,0.031718,0.024264,0,0,0,0/0,0,0,0,0.052237,0.101655,0.197526,0.161478,0,0,0,0.063637,0.202105,0.170165,0.446674,0.216263,0.002606,0,0.134079,0.977292,0.487684,0,0,0.635501,0.95224,0.193279,0,0.02944,0.558451,0.331406,0,0,0.239841,0.404173,0.168174,0.103379,0.366073,0.187566,0.107404,0.100371,0,0,0,0/0,0,0,0,0,0,0,0,0,0.023479,0.005307,0.109363,0.168194,0.103934,0.922615,1,0.003572,0,0,0.891283,0.751339,0,0,0.56351,0.983538,0.514244,0,0.241465,0.902647,0.73782,0.075673,0.010983,0.378851,0.466286,0.164885,0.023692,0.300496,0.349291,0.239932,0.206547,0.052282,0,0,0/0,0,0,0,0,0,0,0,0.051668,0.160116,0.518002,0.28388,0.158412,0.044397,0.519357,1,0.241665,0,0,0.490923,0.590488,0.076465,0,0.44808,0.892167,0.492156,0,0.33834,0.999732,0.841525,0.159316,0.123253,0.607522,0.631928,0.295722,0.079651,0.272277,0.402227,0.342456,0.279198,0.148208,0,0,0/0,0,0,0,0,0,0,0,0.082343,0.153002,0.839735,0.865387,0.17778,0.013239,0.071353,0.629661,0.324254,0,0.002907,0.422271,0.555208,0.457156,0.366059,0.657296,0.839649,0.650757,0.262334,0.577741,1,0.782936,0.164094,0.219321,0.756373,0.754316,0.410822,0.184993,0.335086,0.377247,0.341158,0.26268,0.229853,0,0,0/0,0,0,0,0,0,0,0,0.083835,0.188039,0.34873,0.742375,0.366629,0.003301,0.005183,0.44178,0.399354,0.283372,0.335451,0.446103,0.565206,0.612073,0.64836,0.751226,0.869355,0.884388,0.821438,0.962552,1,0.879207,0.380575,0.479003,0.830017,0.759119,0.382342,0.261325,0.442846,0.358525,0.316263,0.235767,0.246193,0.047708,0,0/0,0,0,0,0,0.006332,0.481629,0.426444,0.067187,0.212791,0.207462,0.481997,0.630057,0.143731,0.091327,0.251107,0.314666,0.308043,0.360611,0.447822,0.549704,0.619126,0.681931,0.778512,0.875395,0.915261,0.947047,1,1,1,0.820864,0.849898,0.866683,0.683627,0.301506,0.337662,0.534296,0.400302,0.319179,0.242289,0.241593,0.097429,0.008105,0/0,0,0,0,0,0,0.133536,0.433554,0.28572,0.239232,0.231601,0.480275,0.54337,0.157289,0.055976,0.121308,0.215748,0.257306,0.312916,0.393285,0.475952,0.559159,0.653275,0.759124,0.83914,0.896016,0.955775,1,1,1,1,0.939957,0.827919,0.661836,0.36962,0.476499,0.596468,0.46919,0.332622,0.259159,0.204115,0.091162,0.054603,0.015284/0,0,0,0,0,0,0,0,0.340109,0.438654,0.302107,0.311527,0.356353,0.146133,0,0.039325,0.111156,0.168367,0.251774,0.344846,0.432541,0.52006,0.613834,0.70963,0.789165,0.870497,0.95072,1,1,1,1,0.95458,0.845621,0.707882,0.586329,0.60911,0.576983,0.473054,0.331441,0.289531,0.154069,0.055596,0.069994,0.047547/0,0,0,0.082578,0,0,0,0,0.322612,0.445761,0.27237,0.147052,0.141629,0.059973,0,0,0.063511,0.14733,0.241083,0.338089,0.432707,0.528258,0.622172,0.721424,0.816426,0.897419,0.97426,1,1,1,1,0.983562,0.897878,0.787113,0.696626,0.579475,0.515622,0.397397,0.315906,0.321896,0.137072,0.050096,0.064598,0.043724/0,0,0,0.097861,0.14848,0.013366,0,0.1235,0.223601,0.328138,0.275651,0.150159,0.070427,0.005661,0,0,0.04465,0.134731,0.228145,0.324183,0.424867,0.524773,0.624491,0.726153,0.821329,0.917562,1,1,1,1,1,0.967609,0.910634,0.829771,0.711738,0.551422,0.473573,0.374758,0.357148,0.326818,0.153681,0.069759,0.052328,0.005143/0,0,0,0,0,0.06834,0.190212,0.137105,0.143136,0.210597,0.23969,0.156621,0.061517,0,0,0,0.011184,0.107482,0.196722,0.292462,0.401711,0.511791,0.619718,0.724693,0.822886,0.926868,1,1,1,0.950685,0.920491,0.917103,0.89501,0.815901,0.708937,0.589567,0.479774,0.405462,0.345433,0.267745,0.19318,0.123545,0.041726,0/0,0,0,0,0,0,0.083134,0.098713,0.125601,0.19685,0.252776,0.159028,0.035406,0,0,0,0,0.028391,0.137171,0.24902,0.365881,0.485798,0.625511,0.74139,0.838857,0.941523,1,1,1,0.94005,0.892939,0.865861,0.814353,0.744771,0.678088,0.598173,0.507846,0.374156,0.234485,0.209422,0.204665,0.149146,0.029674,0/0,0,0,0,0,0,0,0.021553,0.102476,0.202369,0.246542,0.177198,0.035856,0,0,0,0,0,0.166358,0.334578,0.488956,0.637144,0.767309,0.853538,0.921181,0.980365,1,1,1,1,0.942908,0.848181,0.755975,0.688474,0.63288,0.584383,0.50479,0.334906,0.202588,0.171839,0.175853,0.136418,0.012013,0/0,0,0,0,0,0,0,0,0.090779,0.203933,0.235147,0.170495,0.046744,0,0,0,0,0.117619,0.344742,0.512707,0.639499,0.770352,0.881874,0.943975,0.98642,1,1,1,1,1,1,0.863588,0.748134,0.649062,0.579666,0.518961,0.442092,0.335917,0.228758,0.159144,0.130323,0.068827,0,0/0,0,0,0,0,0,0,0,0.045291,0.195569,0.256859,0.166687,0.038694,0,0,0,0,0.112068,0.202898,0.288633,0.366607,0.428158,0.542866,0.685853,0.904842,1,1,1,1,1,1,0.988325,0.775867,0.631428,0.510044,0.431716,0.38471,0.327237,0.239165,0.127835,0.045142,0.011052,0,0/0,0,0,0,0,0,0,0,0.041433,0.205366,0.297721,0.188475,0.02814,0,0,0,0,0,0,0,0,0,0,0,0,0.256516,0.568135,0.762453,1,1,1,1,0.853455,0.609572,0.471593,0.366673,0.318551,0.286355,0.206422,0.062058,0,0,0,0/0,0,0,0,0,0,0,0,0.069596,0.274386,0.336842,0.194055,0.015155,0,0,0,0,0,0,0,0,0,0,0,0,0,0.012968,0.290699,0.424703,0.818569,1,1,1,0.595691,0.438737,0.306623,0.239326,0.21028,0.133746,0.032085,0,0,0,0/0,0,0,0,0,0,0,0,0.046709,0.317367,0.381798,0.175264,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.135187,0.296879,0.792262,1,1,0.843526,0.409774,0.269953,0.171026,0.120043,0.076376,0.019336,0,0,0,0/0,0,0,0,0,0,0,0,0.067582,0.394975,0.420044,0.123535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.078419,0.306551,0.992975,1,1,0.374312,0.215981,0.105893,0.050715,0.039172,0,0,0,0,0/0,0,0,0,0,0,0,0,0.095458,0.477857,0.443728,0.038376,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.073245,0.472583,1,1,0.477533,0.162455,0.052511,0.014475,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.177347,0.604777,0.410003,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.000363,0.148194,0.893728,1,0.620726,0.1065,0.020133,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.301748,0.733106,0.400704,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.045544,0.621035,1,0.687615,0.050964,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.368366,0.817198,0.454557,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001031,0.451119,1,0.628,0.01379,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.489538,0.930671,0.524424,0.014163,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.351995,0.903147,0.625819,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0.004646,0.526837,1,0.641422,0.051395,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.288251,0.770647,0.523432,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0.045832,0.479999,1,0.802161,0.117312,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.274719,0.677319,0.381075,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0.018836,0.101748,0.467206,1,1,0.318614,0.017247,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.300259,0.612476,0.285093,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0.017146,0.051994,0.15394,0.310206,1,1,0.774331,0.107378,0.007235,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.000418,0.34451,0.512001,0.170634,0,0,0,0,0,0,0,0,0/0,0,0,0,0.0358,0.068112,0.112488,0.204679,0.351541,0.878251,1,1,0.500526,0.107366,0.012433,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.038874,0.360124,0.417957,0.128659,0,0,0,0,0,0,0,0,0/0,0,0,0.016553,0.107294,0.150798,0.18564,0.259191,0.391389,0.603444,1,1,1,0.509007,0.208226,0.067014,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.114495,0.346543,0.337407,0.093642,0,0,0,0,0,0,0,0,0/0,0,0,0.055953,0.153765,0.219837,0.246789,0.31049,0.429733,0.588641,0.880697,1,1,1,0.793401,0.501977,0.258849,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001637,0.148088,0.311216,0.26351,0.072389,0,0,0,0,0,0,0,0,0/0,0.004304,0.031541,0.068079,0.158561,0.257594,0.332311,0.389986,0.46856,0.585506,0.70943,1,1,1,1,1,0.842824,0.584423,0.176772,0,0,0,0,0,0,0,0,0,0,0,0.023117,0.15043,0.274665,0.233011,0.095698,0,0,0,0,0,0,0,0,0/0,0.056902,0.05952,0.064568,0.154121,0.3171,0.422969,0.468498,0.509401,0.590895,0.702882,0.845898,1,1,1,1,1,1,0.981411,0.904825,0.78309,0.657481,0.547297,0.438042,0.331467,0.224119,0.056167,0,0,0,0.022876,0.140504,0.251121,0.216591,0.092696,0,0,0,0,0,0,0,0,0/0.012934,0.073271,0.086206,0.091554,0.190459,0.349006,0.443031,0.511233,0.569118,0.635303,0.719899,0.806807,0.924589,1,1,1,1,1,0.983613,0.952942,0.902444,0.805651,0.675339,0.518047,0.318432,0.112676,0,0,0,0,0.022243,0.124156,0.234295,0.230551,0.101393,0,0,0,0,0,0,0,0,0/0.005647,0.066701,0.133408,0.186614,0.258941,0.352088,0.442163,0.540326,0.640325,0.71955,0.762226,0.790578,0.867573,0.996251,1,1,1,0.978536,0.903152,0.821731,0.723144,0.610699,0.478613,0.320838,0.162762,0.025359,0,0,0,0,0.042256,0.158957,0.231408,0.222057,0.100057,0,0,0,0.007889,0,0,0,0,0/0,0.051358,0.190041,0.280942,0.31739,0.346474,0.419493,0.562731,0.703973,0.768417,0.810182,0.827152,0.872073,0.936611,1,1,1,0.949731,0.849024,0.742765,0.632662,0.527885,0.410873,0.292745,0.175485,0.065725,0,0,0,0,0.04703,0.187947,0.231632,0.217765,0.154901,0.090549,0.01556,0,0,0,0.081318,0.065716,0,0/0,0.044154,0.218554,0.298529,0.333122,0.362708,0.404515,0.556883,0.695391,0.781403,0.850426,0.909088,0.970265,0.980259,0.980535,1,1,0.943425,0.851128,0.746495,0.635894,0.532146,0.427554,0.328374,0.228087,0.125219,0.034288,0,0,0,0.038036,0.166518,0.225774,0.210917,0.208578,0.227732,0.123234,0,0,0,0,0,0,0/0,0.055467,0.214333,0.298252,0.383636,0.428918,0.480861,0.552812,0.644822,0.771066,0.879239,0.983709,1,1,1,1,1,0.935029,0.850469,0.753071,0.649538,0.549045,0.450261,0.357353,0.260207,0.160364,0.070014,0,0,0,0.036697,0.193306,0.332626,0.265774,0.257256,0.315384,0.216391,0,0,0,0,0,0,0/0.016567,0.093285,0.20466,0.287134,0.384424,0.484363,0.479225,0.472987,0.606033,0.719517,0.862649,0.986517,1,1,1,1,0.964714,0.912245,0.834689,0.739863,0.639375,0.544999,0.452676,0.359703,0.264332,0.172985,0.088531,0.015862,0,0,0.029174,0.218167,0.46993,0.358675,0.152526,0.096259,0.075172,0.246369,0.12551,0,0,0,0,0/0.037893,0.156878,0.209825,0.25348,0.325273,0.4767,0.369545,0.365405,0.619124,0.716952,0.84983,0.937997,1,1,1,1,0.952468,0.895148,0.826783,0.720732,0.620514,0.545735,0.464314,0.37554,0.291899,0.222612,0.161195,0.088532,0.10909,0.172095,0.123565,0.235,0.561758,0.459892,0.044639,0.056979,0,0.002986,0.234704,0.026317,0,0,0,0/0.029765,0.190823,0.230002,0.235841,0.282774,0.413939,0.322977,0.429764,0.683839,0.761223,0.722176,0.786733,1,1,1,1,0.979026,0.945262,0.855936,0.744173,0.670951,0.606562,0.533286,0.451481,0.376385,0.299724,0.219179,0.151823,0.185489,0.405917,0.309217,0.152218,0.395631,0.490769,0.157378,0.009673,0,0,0,0,0,0,0,0/0,0.185604,0.24386,0.250356,0.296471,0.34925,0.302721,0.529042,0.723992,0.699223,0.391887,0.53244,0.961309,1,1,0.989134,0.993557,0.95078,0.845959,0.76218,0.723367,0.660158,0.554464,0.472017,0.420686,0.368612,0.239829,0.146015,0.213211,0.611878,0.342242,0.171492,0.229029,0.441837,0.618936,0.255119,0,0,0,0,0,0,0,0/0,0.141699,0.238284,0.256854,0.328824,0.273428,0.262628,0.513155,0.6729,0.590042,0.210182,0.475216,0.952248,0.973709,0.604245,0.642838,0.968123,0.925512,0.781209,0.712488,0.717995,0.663732,0.519465,0.430401,0.399502,0.431095,0.24476,0,0,0.644957,0.567578,0.212725,0.209208,0.135442,0.429103,0.43056,0,0,0,0,0,0,0,0/0,0.059686,0.149596,0.192331,0.337414,0.199768,0.183926,0.439859,0.571867,0.43847,0.181147,0.57202,0.988397,0.822527,0.174768,0.254019,0.867131,0.872046,0.381565,0.225051,0.563772,0.643189,0.285455,0,0.09492,0.500105,0.284096,0,0,0.641832,0.974054,0.500238,0.213643,0.119387,0,0,0,0,0,0,0,0,0,0/0,0,0.043655,0.061463,0.287415,0.226803,0.147848,0.369004,0.456989,0.239816,0.066113,0.519482,0.93534,0.738044,0.074104,0.200764,0.914651,0.862111,0.090246,0,0.412219,0.756609,0.174324,0,0,0.777071,0.831562,0,0,0.300915,0.947046,0.788523,0.223672,0.098024,0,0,0,0,0.01479,0.055179,0,0,0,0/0,0,0,0,0.145683,0.30073,0.2361,0.399157,0.427969,0.090856,0,0.215601,0.683002,0.501121,0,0.140075,0.915915,0.934902,0.048047,0,0.354105,0.952957,0.452469,0,0,0.779377,1,0.163876,0,0.169123,0.156843,0.166709,0.190094,0.060581,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0.032953,0.282903,0.310843,0.433378,0.48535,0.143527,0,0,0.322263,0.156397,0,0,0.465705,0.69842,0.002265,0,0,0.792533,0.471868,0,0,0.055185,0.559184,0.07055,0.044837,0.175286,0.12352,0.106733,0.123568,0.02174,0.017715,0,0,0,0,0,0.000652,0,0,0/0,0,0,0,0,0.170069,0.302715,0.337638,0.400848,0.341919,0,0,0.247908,0.092156,0,0,0,0.118894,0,0,0,0,0,0,0,0.033331,0.122388,0.092108,0.134161,0.187707,0.081017,0.071687,0.056005,0.210745,0.364132,0.243014,0.185789,0.121545,0,0,0,0,0,0/0,0,0,0,0,0.038661,0.226274,0.238061,0.244923,0.392944,0.150731,0.111464,0.389645,0.330945,0,0,0,0,0,0,0,0,0,0,0,0.061179,0.102168,0.140775,0.230676,0.267825,0.057761,0.045599,0.008608,0.082566,0.284285,0.266068,0.170404,0,0,0,0,0,0,0/0,0,0,0,0,0,0.090747,0.145379,0.139454,0.275146,0.347086,0.253171,0.43693,0.462226,0.211596,0,0,0.04752,0.135917,0,0,0,0,0.042394,0.154316,0.175899,0.166306,0.202871,0.458726,0.550515,0.443196,0.382689,0.33771,0.299665,0.287758,0.27702,0.141567,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0.056508,0.061558,0.11726,0.33352,0.381706,0.405928,0.432556,0.422571,0.170139,0,0.179766,0.401273,0.341455,0.002448,0,0.011319,0.451657,0.627732,0.53016,0.302512,0.238309,0.382966,0.50592,0.496298,0.456192,0.340513,0.135789,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0.018608,0.019806,0.105825,0.348016,0.403945,0.407506,0.449103,0.509171,0.353663,0.278584,0.413415,0.531127,0.56555,0.395289,0.292934,0.509097,0.670915,0.724596,0.747509,0.684908,0.586671,0.545543,0.519875,0.37057,0.037773,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0.072529,0.309885,0.383285,0.383965,0.420763,0.568888,0.510581,0.470975,0.597198,0.72618,0.787714,0.809582,0.719645,0.730173,0.751608,0.585562,0.340147,0.255145,0.293502,0.253242,0.054723,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0.023807,0.211983,0.239964,0.161082,0.209249,0.48069,0.606493,0.659958,0.574932,0.35245,0.367863,0.585861,0.677878,0.575845,0.263121,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.052576,0,0,0,0.173948,0.399634,0.309381,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0"
    , grid);
    while(running) {
        frameStart = SDL_GetTicks();
        frameCount++;
        if (frameStart - lastTime >= 1000) {
            fps = frameCount;
            frameCount = 0;
            lastTime = frameStart;
            printf("FPS: %d\n", fps);
        }
        while(SDL_PollEvent(&event)) {
            ImGui_ImplSDL2_ProcessEvent(&event);
            if(event.type == SDL_QUIT) {
                running = false;
            }

            if(event.type == SDL_KEYDOWN) {
                if (event.key.keysym.sym == SDLK_r) {
                    grid.clear();
                    for (int i = 0; i < randomSpots; i++) {
                        grid.set(rand() % 128, rand() % 128, 1);
                    }
                }
                if(event.key.keysym.sym == SDLK_ESCAPE) {
                    running = false;
                }
            }
        }
        SDL_SetRenderTarget(renderer, texture);
        SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
        SDL_RenderClear(renderer);
        grid.draw(5);
        grid.calcMoments();
        grid.updateStats();

        SDL_SetRenderTarget(renderer, NULL);

        ImGui_ImplSDLRenderer2_NewFrame();
        ImGui_ImplSDL2_NewFrame(window);
        ImGui::NewFrame();
        ImGui::Begin("Lenia Viewer");
        ImGui::Image((ImTextureID)texture, ImVec2(640, 640));
        ImGui::End();
        ImGui::Begin("stats");
        grid.plotStats();
        ImGui::End();

        ImGui::Render();

        grid.update();

        SDL_RenderClear(renderer);
        ImGui_ImplSDLRenderer2_RenderDrawData(ImGui::GetDrawData());

        SDL_RenderPresent(renderer);

        frameTime = SDL_GetTicks() - frameStart;
    }

    ImGui_ImplSDLRenderer2_Shutdown();
    ImGui_ImplSDL2_Shutdown();
    ImPlot::DestroyContext();
    ImGui::DestroyContext();
    SDL_DestroyTexture(texture);

    SDL_DestroyRenderer(renderer);
    SDL_DestroyWindow(window);
    SDL_Quit();
    cleanupMath();
    return 0;
}

#ifdef _WIN32
#include <windows.h>

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    return main(__argc, __argv);
}
#endif